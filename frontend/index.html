<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script>
  // 🚀 Instantly apply saved theme *before* the page renders
  (() => {
    try {
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const shouldBeDark = savedTheme === "dark" || (!savedTheme && prefersDark);

      if (shouldBeDark) {
        document.documentElement.classList.add("dark-preload");
        document.documentElement.style.backgroundColor = "#121212";
      } else {
        document.documentElement.style.backgroundColor = "#f5f7fa";
      }
    } catch (e) {
      console.error("Theme preload error:", e);
    }
  })();
</script>
  <title>FinSight</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Bebas+Neue&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
        --bg-color: #f5f7fa;
        --text-color: #333;
        --header-gradient-start: #4facfe;
        --header-gradient-end: #00f2fe;
        --card-bg-color: #ffffff;
        --card-shadow-color: rgba(0,0,0,0.05);
        --tab-border-color: #ddd;
        --item-card-bg: #f9f9f9;
        --progress-bar-bg: #e0e0e0;
        --delete-btn-bg: #ff4d4d;
        --delete-btn-hover-bg: #e60000;
        --overspent-color: #f44336;
        --modal-overlay-bg: rgba(0, 0, 0, 0.6);
    }

    body.dark-mode {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --header-gradient-start: #1e3c72;
        --header-gradient-end: #2a5298;
        --card-bg-color: #1e1e1e;
        --card-shadow-color: rgba(0,0,0,0.4);
        --tab-border-color: #333;
        --item-card-bg: #2c2c2c;
        --progress-bar-bg: #444;
        --delete-btn-bg: #c82333;
        --delete-btn-hover-bg: #a71d2a;
        --overspent-color: #ff4d4d;
        --modal-overlay-bg: rgba(0, 0, 0, 0.7);
    }

    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background: var(--bg-color); 
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    header { 
        background: linear-gradient(90deg, var(--header-gradient-start), var(--header-gradient-end)); 
        padding: 15px 20px; 
        color: white; 
        text-align: center; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: flex;
        justify-content: center;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1001; /* Higher z-index to stay on top */
    }
    h1 { margin: 0; text-align: center; line-height: 1.2; }
    h1 .main-title { 
        font-family: 'Bebas Neue', sans-serif;
        font-size: 2.8rem; 
        display: block; 
        letter-spacing: 4px;
        font-weight: 400;
    }
    h1 .subtitle { font-family: 'Caveat', cursive; font-size: 1.5rem; font-style: normal; font-weight: 400; display: block; opacity: 0.9; margin-top: 0px; }
    #tabs { display: flex; flex-wrap: wrap; justify-content: center; background: var(--card-bg-color); border-bottom: 1px solid var(--tab-border-color); box-shadow: 0 2px 4px var(--card-shadow-color); position: sticky; top: 83px; z-index: 1000; }
    .tab { cursor: pointer; padding: 15px 25px; transition: 0.3s; }
    .tab:hover { background: #f0f0f0; }
    body.dark-mode .tab:hover { background: #333; }
    .tab.active { background: var(--header-gradient-start); color: white; border-radius: 5px 5px 0 0; }
    .tab-content { display: none; max-width: 900px; margin: 30px auto; padding: 20px; background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 10px var(--card-shadow-color); }
    .tab-content h2, .tab-content h3, .step-card h3 {
        font-family: 'Bebas Neue', sans-serif;
        letter-spacing: 2px;
        font-weight: 400;
    }
     .tab-content h2 { font-size: 2.5rem; }
    .tab-content h3, .step-card h3 { font-size: 1.8rem; }
    form label { margin: 0 5px 0 10px; font-weight: 500; color: #555; }
    body.dark-mode form label { color: #bbb; }
    form input, form select, form button { width: 100%; box-sizing: border-box; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
    body.dark-mode form input, body.dark-mode form select { background-color: #333; color: #e0e0e0; border-color: #555; }
    form button { background: var(--header-gradient-start); color: white; border: none; cursor: pointer; transition: 0.3s; }
    form button:hover { background: var(--header-gradient-end); }
    .item-card { background: var(--item-card-bg); padding: 10px 15px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px var(--card-shadow-color); }
    .delete-btn { background: var(--delete-btn-bg); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .delete-btn:hover { background: var(--delete-btn-hover-bg); }
    .progress-bar-container { background: var(--progress-bar-bg); border-radius: 8px; overflow: hidden; height: 20px; width: 100%; margin-top: 5px; position: relative; }
    .progress-bar { background: #4caf50; height: 100%; transition: width 0.5s ease-in-out; }
    .progress-bar.over { background: var(--overspent-color); }
    #theme-toggle { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: white; padding: 0 0 0 20px; }
    .header-right { 
        display: flex; 
        align-items: center; 
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
    }
    .summary-card {
        background: var(--item-card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px var(--card-shadow-color);
    }
    .progress-bar.cracked {
        background-image: linear-gradient(135deg, rgba(0,0,0,0.2) 25%, transparent 25%),
                          linear-gradient(225deg, rgba(0,0,0,0.2) 25%, transparent 25%);
        background-size: 10px 10px;
    }

    /* Mobile Navigation */
    #menu-toggle {
        width: 30px;
        height: 24px;
        background: transparent;
        border: none;
        cursor: pointer;
        display: none; /* Default state is hidden, shown in media query */
        padding: 0;
        flex-direction: column;
        justify-content: space-between;
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
    }
    #menu-toggle span {
        display: block;
        height: 3px;
        width: 100%;
        background: white;
        border-radius: 3px;
    }
    #mobile-nav { height: 100%; width: 250px; position: fixed; z-index: 2000; top: 0; left: 0; background-color: var(--card-bg-color); overflow-x: hidden; transition: 0.3s; transform: translateX(-100%); padding-top: 80px; box-shadow: 3px 0 6px rgba(0,0,0,0.2); }
    #mobile-nav.open { transform: translateX(0); }
    #mobile-nav a { padding: 10px 15px; text-decoration: none; font-size: 18px; color: var(--text-color); display: block; transition: 0.2s; }
    #mobile-nav a:hover { background-color: var(--header-gradient-start); color: white; }
    #mobile-nav .close-btn { position: absolute; top: 15px; right: 25px; font-size: 36px; margin-left: 50px; color: var(--text-color); text-decoration: none; }
    #mobile-nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
    #mobile-nav-overlay.open { display: block; }

    /* Grid Layouts */
    .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    /* Chart Layout Fix */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.charts-grid .chart-container {
  position: relative;
  width: 100%;
  height: auto;
  min-height: 400px;
  background: var(--card-bg-color);
  border-radius: 12px;
  box-shadow: 0 4px 10px var(--card-shadow-color);
  padding: 15px;
  box-sizing: border-box;
  overflow: hidden;
}

.charts-grid .chart-container canvas {
  display: block;
  width: 100% !important;
  height: 100% !important;
  max-height: 400px;
}

@media (max-width: 900px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  .charts-grid .chart-container {
    min-height: 300px;
    padding: 10px;
  }
  .charts-grid .chart-container canvas {
    max-height: 300px;
  }
}

@media (max-width: 600px) {
  .charts-grid .chart-container {
    min-height: 250px;
    padding: 8px;
  }
  .charts-grid .chart-container canvas {
    max-height: 250px;
  }
}

/* --- Home Tab Steps Grid --- */
.steps-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 25px;
  max-width: 800px;
  margin: 0 auto; /* centers the whole grid on the page */
}

.step-card {
  background: var(--item-card-bg);
  box-shadow: 0 2px 6px var(--card-shadow-color);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
}

.step-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 12px var(--card-shadow-color);
}

.step-number {
  font-size: 2.5rem;
  font-weight: bold;
  color: var(--header-gradient-start);
  margin-bottom: 10px;
}

.step-card h3 {
  margin: 8px 0;
  font-size: 1.2rem;
  font-weight: 600;
}

.step-card p {
  font-size: 0.95rem;
  opacity: 0.85;
  margin: 0;
  max-width: 90%;
}

/* Make grid stack into 1 column on mobile */
@media (max-width: 768px) {
  .steps-container {
    grid-template-columns: 1fr;
  }
}


    /* Collapsible Category Styles */
    .category-header { cursor: pointer; user-select: none; font-weight: bold; padding: 10px; border-radius: 5px; transition: background-color 0.2s; }
    .category-header:hover { background-color: var(--item-card-bg); }
    .category-header::before { content: '▶ '; font-size: 0.8em; transition: transform 0.2s; display: inline-block; }
    .category-header.open::before { transform: rotate(90deg); }
    .category-transactions { display: none; padding-left: 20px; }
    
    /* Empty State Styles */
    .empty-state { text-align: center; padding: 40px 20px; opacity: 0.7; }
    .empty-state svg { width: 60px; height: 60px; margin-bottom: 15px; fill: var(--text-color); }
    .empty-state h4 { margin: 0 0 10px 0; font-size: 1.2rem; }
    .empty-state p { margin: 0; color: #888; }
    body.dark-mode .empty-state p { color: #aaa; }

    /* Loader Styles */
    #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay-bg); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--header-gradient-start); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Custom Modal Styles */
    #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay-bg); z-index: 2500; display: none; justify-content: center; align-items: center; padding: 20px; }
    #modal { background: var(--card-bg-color); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 400px; width: 100%; text-align: center; }
    #modal h3 { margin: 0 0 15px 0; }
    #modal p { margin: 0 0 20px 0; }
    #modal input, #modal select { width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
    body.dark-mode #modal input, body.dark-mode #modal select { background-color: #333; color: #e0e0e0; border-color: #555; }
    #modal-buttons { display: flex; justify-content: center; gap: 15px; }
    #modal-buttons button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.2s; }
    #modal-confirm-btn { background: var(--header-gradient-start); color: white; }
    #modal-confirm-btn:hover { opacity: 0.9; }
    #modal-cancel-btn { background: #ccc; color: #333; }
    #modal-cancel-btn:hover { background: #bbb; }

    /* Bulk Edit Styles */
    #bulk-edit-container {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: var(--item-card-bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px var(--card-shadow-color);
    }
    .transaction-checkbox {
        width: 20px;
        height: 20px;
        accent-color: var(--header-gradient-start);
        margin-right: 15px;
    }

    #transaction-list-container {
        margin-top: 40px;
    }
    
    #price-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    #price-table th, #price-table td {
        padding: 12px;
        border-bottom: 1px solid var(--tab-border-color);
    }
    #price-table th {
        text-align: left;
        font-weight: 600;
    }
     #price-table td:last-child {
        text-align: right;
        font-weight: 500;
    }

    /* Responsive Styles */
    @media (max-width: 900px) {
      .chart-container {
        height: auto; /* let chart size itself */
        min-height: 300px;
        padding: 10px;
      }
      .chart-container canvas {
        max-height: 300px;
      }
    }
    @media (max-width: 768px) {
        #tabs { display: none; }
        #menu-toggle { display: flex; }
        .tab-content { padding: 15px; margin: 15px; }
        h1 { font-size: 1.2rem; }
        h1 .main-title { font-size: 1.5rem; }
        h1 .subtitle { font-size: 0.8rem; }
        .overview-grid, .charts-grid { grid-template-columns: 1fr; } /* Stack content vertically */
    }
     @media (max-width: 600px) {
      .chart-container {
        min-height: 250px;
        padding: 8px;
      }
      .chart-container canvas {
        max-height: 250px;
      }
    }
  </style>
</head>
<body>
  <header>
    <button id="menu-toggle" aria-label="Open menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <h1>
        <span class="main-title">FinSight</span>
        <span class="subtitle">your personal finance manager</span>
    </h1>
    <div class="header-right">
        <button id="theme-toggle">🌙</button>
    </div>
  </header>
  
  <div id="mobile-nav-overlay"></div>
  <nav id="mobile-nav">
      <a href="javascript:void(0)" class="close-btn">&times;</a>
      <a href="#" class="mobile-nav-link" data-tab="home">Home</a>
      <a href="#" class="mobile-nav-link" data-tab="spending">Spending Analysis</a>
      <a href="#" class="mobile-nav-link" data-tab="categorize">Categorize</a>
      <a href="#" class="mobile-nav-link" data-tab="budgets">Budgets</a>
      <a href="#" class="mobile-nav-link" data-tab="insights">Insights</a>
      <a href="#" class="mobile-nav-link" data-tab="wishlist">Wishlist</a>
  </nav>

  <div id="tabs">
    <div class="tab" data-tab="home">Home</div>
    <div class="tab" data-tab="spending">Spending Analysis</div>
    <div class="tab" data-tab="categorize">Categorize</div>
    <div class="tab" data-tab="budgets">Budgets</div>
    <div class="tab" data-tab="insights">Insights</div>
    <div class="tab" data-tab="wishlist">Wishlist</div>
  </div>

  <!-- Home Tab -->
  <div id="home" class="tab-content">
      <h2 style="text-align: center;">Welcome to FinSight</h2>
      <p style="text-align: center; font-size: 1.1rem; margin-bottom: 40px;">Follow these simple steps to get started:</p>

<div class="steps-container">
  <div class="step-card">
    <div class="step-number">1</div>
    <h3>Upload CSV</h3>
    <p>Go to the 'Spending Analysis' tab and upload your CSV file.</p>
  </div>
  <div class="step-card">
    <div class="step-number">2</div>
    <h3>Categorize</h3>
    <p>Go to the 'Categorize' tab to change around categories and edit your transactions.</p>
  </div>
  <div class="step-card">
    <div class="step-number">3</div>
    <h3>Add Budgets</h3>
    <p>Go to the 'Budgets' tab and set your monthly spending limits.</p>
  </div>
  <div class="step-card">
    <div class="step-number">4</div>
    <h3>Get Insights & Plan</h3>
    <p>See your insights and make a wishlist of items you need.</p>
  </div>
</div>
</div> <!-- close home tab -->


  <!-- Budgets Tab -->
  <div id="budgets" class="tab-content">
      <h2>Set Monthly Budgets</h2>
      <form id="budgetForm">
          <label for="budgetCategory">Category:</label>
          <select id="budgetCategory" required></select>
          <label for="budgetAmount">Amount:</label>
          <input type="number" id="budgetAmount" placeholder="e.g., 500" required />
          <button type="submit">Set Budget</button>
      </form>
      <div id="budgetsList" style="margin-top: 20px;"></div>
  </div>

  <!-- Spending Tab -->
  <div id="spending" class="tab-content">
    <h2>Spending Analysis</h2>
    <form style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
        <label for="bankType">Bank:</label>
        <select id="bankType" style="width: auto; flex-grow: 1;">
            <option value="barclays">Barclays</option>
            <option value="aqua">Aqua</option>
        </select>
        <input type="file" id="csvUpload" multiple style="width: auto; flex-grow: 2;" />
        <button type="button" id="deleteCsv">Delete CSV</button>
    </form>
    
    <div id="initial-spending-prompt"></div>
    
    <div id="spending-content-wrapper" style="display: none;">
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Spending by Category (Pie)</h3>
                <canvas id="spendingChart"></canvas>
            </div>
            <div class="chart-container">
                 <h3>Spending by Category (Bar)</h3>
                 <canvas id="spendingBarChart"></canvas>
            </div>
        </div>
    </div>
  </div>

  <!-- Insights Tab -->
  <div id="insights" class="tab-content">
      <h2>Your Financial Insights</h2>
      <div id="insights-container" style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
          <!-- Insights will be populated here by JavaScript -->
      </div>
  </div>

  <!-- Categorize Tab -->
  <div id="categorize" class="tab-content">
    <h2>Categorize</h2>
    <p style="text-align: center; font-style: italic; opacity: 0.8; margin-top: -10px; margin-bottom: 20px;">(Hint: Double-click on a transaction name to edit it)</p>
    <div id="transaction-list-container">
        <div id="bulk-edit-container" style="display: none;">
            <span id="selected-count">0 items selected</span>
            <button id="bulk-edit-btn">Edit Selected</button>
        </div>
        <div id="categoryView"></div>
    </div>
    <div id="price-table-container" style="margin-top: 40px;"></div>
  </div>


  <!-- Wishlist Tab -->
  <div id="wishlist" class="tab-content">
    <h2>Wishlist</h2>
    <form id="wishlistForm">
      <label for="wishName">Item:</label>
      <input type="text" id="wishName" placeholder="e.g., New Keyboard" required />
      <label for="wishAmount">Price:</label>
      <input type="number" id="wishAmount" placeholder="e.g., 150" required />
      <label for="wishPriority">Priority:</label>
      <select id="wishPriority">
        <option value="1">High</option>
        <option value="2">Medium</option>
        <option value="3">Low</option>
      </select>
      <button type="submit">Add</button>
    </form>
    <div id="wishlistItems"></div>
    <div class="wishlist-order">
      <h3>Suggested Purchase Order</h3>
      <ol id="wishlistOrder"></ol>
    </div>
  </div>
    
    <!-- Global Loader -->
    <div id="loader-overlay">
        <div class="loader"></div>
    </div>

    <!-- Custom Modal -->
    <div id="modal-overlay">
        <div id="modal">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <select id="modal-category-select" style="display: none;"></select>
            <input type="text" id="modal-input" style="display: none;" />
            <div id="modal-buttons">
                <button id="modal-cancel-btn">Cancel</button>
                <button id="modal-confirm-btn">OK</button>
            </div>
        </div>
    </div>


  <script>
    
    const API_BASE = "https://finsight-xp7a.onrender.com/api";

    async function handleCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    const text = e.target.result;
    const lines = text.split("\n").slice(1); // skip header row
    let uploadedCount = 0;

    for (const line of lines) {
      if (!line.trim()) continue;
      const [date, description, category, amount, type] = line.split(",");

      // Skip bad rows
      if (!date || !description || isNaN(parseFloat(amount))) continue;

      try {
        const res = await fetch(`${API_BASE}/transactions`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            account_id: 1,
            date: date.trim(),
            description: description.trim(),
            category: category?.trim() || null,
            amount: parseFloat(amount),
            type: type?.trim() || "expense",
          }),
        });

        if (res.ok) uploadedCount++;
      } catch (err) {
        console.error("Upload failed for line:", line, err);
      }
    }

    alert(`✅ Uploaded ${uploadedCount} transactions successfully!`);
    await loadData(); // refresh everything
    renderAll();
  };

  reader.readAsText(file);
}

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async() => {
        // Load all data from localStorage
        await loadData();
        
        // Setup UI
        setupTheme();
        setupNavigation();

        // Initial render of all components
        renderAll();

        // Event Listeners
        document.getElementById('wishlistForm').onsubmit = handleAddWishlistItem;
        document.getElementById('csvUpload').addEventListener('change', handleCSV);
        document.getElementById('budgetForm').onsubmit = handleAddBudget;
        document.getElementById('deleteCsv').onclick = () => {
            transactions = [];
            localStorage.removeItem('transactions');
            renderAll();
        };
        document.getElementById('bulk-edit-btn').onclick = handleBulkEdit;
    });

    // --- DATA MANAGEMENT ---
    let wishlist = [];
    let transactions = [];
    let budgets = [];
    let categoryRules = {};
    const smartCategoryRules = {
        "Groceries": /tesco|asda|sainsbury|aldi|lidl|morrisons|waitrose|coop|co-op|spar|iceland|farmfoods|marks ?&? spencer|m&s|m and s food|booths|londis|heron foods|b&m|home bargains|costcutter|nisa|one stop|bargain booze/,
        "Transport": /uber|bolt|tfl|transport for london|trainline|bus|rail|shell|esso|bp|petrol|fuel|parking|ncp|stagecoach|national express|parkingeye|railway|avanti|great western|scotrail|northern rail|southern rail|gatwick express|dvla/,
        "Eating Out": /restaurant|cafe|bar|pub|pizza|burger|kfc|mcdonald|starbucks|pret|coffee|nero|costacoffee|greggs|just ?eat|deliveroo|uber ?eats|dominos|domino'?s|subway|wagamama|nando|harvester|toby carvery|brewdog|wetherspoon|five guys|krispy kreme|waxy o connors/,
        "Bills": /rent|mortgage|council|bill|energy|gas|electric|water|broadband|ee|vodafone|sky|virgin|plusnet|bt|talktalk|ovo|octopus|edf|british gas|thames water|tv license|utilities|sse/,
        "Shopping": /amazon|amzn|ebay|argos|ikea|currys|apple|google|playstore|asos|shein|zalando|uniqlo|h&m|zara|next|primark|sports direct|footasylum|game|b&q|screwfix|toolstation|wilko|john lewis|very\.co|studio\.co|clarks|boohoo|missguided|vinted|aliexpress|wish\.com|notonthehighstreet/,
        "Entertainment": /netflix|spotify|disney|prime|cinema|vue|odeon|cineworld|concert|theatre|music|game pass|playstation|psn|xbox|nintendo|steam|twitch|eventbrite|ticketmaster|audible/,
        "Health": /nhs|pharmacy|chemist|dentist|doctor|optician|specsavers|vision express|boots|superdrug|clinic|bupa|hca|nuffield|spire|vets4pets|vet group|vaccination|hospital|mydentist|dental/,
        "Fitness": /gym|puregym|peloton|classpass|fitness|yoga|pilates|anytime fitness|the gym group|snap fitness|fitness first|fitbit|nike run|adidas running|strava|gymshark|kcl sport/,
        "Payments": /repayment|payment|transfer|balance|loan|paypal|revolut|monzo|starling|halifax|lloyds|santander|barclays|hsbc|nationwide|natwest|bank|credit card|direct debit|dd |standing order|finance|klarna|clearpay|afterpay|zip pay|aqua/,
        "Travel & Holidays": /airbnb|expedia|booking\.com|easyjet|ryanair|british airways|travelodge|premier inn|hotel|holiday inn|marriott|hilton|ihg|trivago|holiday|trip\.com|jet2|tui|thomson|thomas cook|trainline|railcard|bus|coach/,
        "Charity & Donations": /justgiving|donation|charity|red cross|oxfam|unicef|save the children|rspca|cancer research|macmillan|mind charity|shelter|wateraid|greenpeace|donor/,
        "Education": /udemy|coursera|edx|open university|school|college|university|exam|textbook|study|tuition|education|mytutorweb/,
        "Insurance": /insurance|insure|axa|aviva|admiral|direct line|churchill|lv=|hastings|esure|compare the market|confused\.com|car insurance|home insurance/,
        "Subscriptions": /subscript|renewal|membership|patreon|onlyfans|newspaper|magazine|times|guardian|telegraph|ft\.com|medium|nyt|subscription|openai|chatgpt/,
        "Pets": /pet|vets|vet group|petplan|paws|tails\.com|pets at home/,
        "House & Garden": /homebase|wickes|b&q|screwfix|toolstation|gardening|garden centre|home improvement|furniture|decor|paint|diy/,
        "Technology": /currys|pc world|scan\.co\.uk|overclockers|ebuyer|argos tech|apple|google|samsung|oneplus|xiaomi|huawei|laptop|computer|electronics|tech/,
    };


    // Chart instances
    let spendingPieChart = null;
    let spendingBarChart = null;

// --- BUDGET API FUNCTIONS ---
async function getBudgets() {
  const res = await fetch(`${API_BASE}/budgets`);
  return await res.json();
}

async function addBudget(category, limit_amount) {
  const res = await fetch(`${API_BASE}/budgets`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ category, limit_amount }),
  });
  return await res.json();
}

async function deleteBudget(id) {
  await fetch(`${API_BASE}/budgets/${id}`, { method: "DELETE" });
}

// --- WISHLIST API FUNCTIONS ---
async function getWishlist() {
  const res = await fetch(`${API_BASE}/wishlist`);
  return await res.json();
}

async function addWishlistItem(name, amount, priority = 1) {
  const res = await fetch(`${API_BASE}/wishlist`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, amount, priority }),
  });
  return await res.json();
}

async function deleteWishlistItem(id) {
  await fetch(`${API_BASE}/wishlist/${id}`, { method: "DELETE" });
}

async function loadData() {
  // ✅ Load wishlist from backend API
  wishlist = await getWishlist();
        transactions = await (await fetch(`${API_BASE}/transactions`)).json();
        budgets = await getBudgets();
        const savedRules = JSON.parse(localStorage.getItem('categoryRules'));
        const defaultRules = {};

        if (savedRules && Object.keys(savedRules).length > 0) {
            categoryRules = {};
            for (const cat in savedRules) {
                categoryRules[cat] = savedRules[cat].map(r => new RegExp(r.source, r.flags));
            }
        } else {
            categoryRules = defaultRules;
        }
    }
    
// --- WISHLIST DELETE HANDLER ---
async function removeWishlistItemById(id) {
  const confirmed = await customConfirm(
    "Delete Wishlist Item",
    "Are you sure you want to delete this item?"
  );
  if (confirmed) {
    await deleteWishlistItem(id); // uses the API helper
    await loadData(); // refresh list from backend
    renderAll();
  }
}

    function renderAll() {
        renderWishlist();
        renderBudgets();
        populateCategoryDropdowns();
        renderSpendingTab();
        renderTransactionsTab();
        renderInsightsTab();
    }
    
    // --- UI SETUP & UX ---
    function setupNavigation() {
        const desktopTabs = document.querySelectorAll('.tab');
        const mobileLinks = document.querySelectorAll('.mobile-nav-link');
        const menuToggle = document.getElementById('menu-toggle');
        const mobileNav = document.getElementById('mobile-nav');
        const overlay = document.getElementById('mobile-nav-overlay');
        const closeBtn = document.querySelector('#mobile-nav .close-btn');

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabId).style.display = 'block';
            const activeTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (activeTab) activeTab.classList.add('active');
        }

        function closeMobileMenu() {
            mobileNav.classList.remove('open');
            overlay.classList.remove('open');
        }

        desktopTabs.forEach(tab => {
            tab.onclick = () => showTab(tab.dataset.tab);
        });

        mobileLinks.forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                showTab(link.dataset.tab);
                closeMobileMenu();
            };
        });

        menuToggle.onclick = () => {
            mobileNav.classList.add('open');
            overlay.classList.add('open');
        };

        closeBtn.onclick = closeMobileMenu;
        overlay.onclick = closeMobileMenu;

        showTab('home'); // Set initial tab
    }
    
    function showLoader() {
        document.getElementById('loader-overlay').style.display = 'flex';
    }

    function hideLoader() {
        document.getElementById('loader-overlay').style.display = 'none';
    }

    // --- CUSTOM MODALS ---

    function customAlert(title, message) {
        return new Promise((resolve) => {
            const modalOverlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-category-select').style.display = 'none';
            document.getElementById('modal-cancel-btn').style.display = 'none';
            document.getElementById('modal-confirm-btn').textContent = 'OK';
            modalOverlay.style.display = 'flex';

            const confirmBtn = document.getElementById('modal-confirm-btn');
            
            const listener = () => {
                modalOverlay.style.display = 'none';
                confirmBtn.removeEventListener('click', listener);
                resolve(true);
            };
            confirmBtn.addEventListener('click', listener);
        });
    }

    function customConfirm(title, message) {
        return new Promise((resolve) => {
            const modalOverlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-category-select').style.display = 'none';
            document.getElementById('modal-cancel-btn').style.display = 'inline-block';
            document.getElementById('modal-confirm-btn').textContent = 'Confirm';
            modalOverlay.style.display = 'flex';

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const confirmListener = () => {
                modalOverlay.style.display = 'none';
                confirmBtn.removeEventListener('click', confirmListener);
                cancelBtn.removeEventListener('click', cancelListener);
                resolve(true);
            };
            const cancelListener = () => {
                modalOverlay.style.display = 'none';
                confirmBtn.removeEventListener('click', confirmListener);
                cancelBtn.removeEventListener('click', cancelListener);
                resolve(false);
            };

            confirmBtn.addEventListener('click', confirmListener);
            cancelBtn.addEventListener('click', cancelListener);
        });
    }
    
    // --- THEME ---
    function setupTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const currentTheme = localStorage.getItem('theme') || 'light';

        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '☀️';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            let theme = 'light';
            if (document.body.classList.contains('dark-mode')) {
                theme = 'dark';
                themeToggle.textContent = '☀️';
            } else {
                themeToggle.textContent = '🌙';
            }
            localStorage.setItem('theme', theme);
            renderCharts();
        });
    }

    // --- WISHLIST ---
function renderWishlist() {
  const wishlistContainer = document.getElementById('wishlistItems');
  wishlistContainer.innerHTML = '';

  if (!wishlist || wishlist.length === 0) {
    wishlistContainer.innerHTML = '<p class="empty">Your wishlist is empty.</p>';
    return;
  }

  wishlist.forEach((item) => {
    const div = document.createElement('div');
    div.className = 'wishlist-item';
    div.innerHTML = `
      <span>${item.name} - £${Number(item.amount).toFixed(2)} (Priority: ${item.priority})</span>
      <button class="delete-btn" onclick="removeWishlistItemById(${item.id})">Delete</button>
    `;
    wishlistContainer.appendChild(div);
  });
}

    function renderWishlistOrder() {
      const orderList = document.getElementById('wishlistOrder');
      orderList.innerHTML = '';
      if(wishlist.length === 0) return;

      const calculateScore = (item) => {
          const priorityWeight = { 1: 400, 2: 200, 3: 100 };
          const baseScore = priorityWeight[item.priority] || 0;
          return baseScore - item.amount;
      };

      const sorted = [...wishlist].sort((a, b) => calculateScore(b) - calculateScore(a));

      sorted.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - £${item.amount.toFixed(2)} (Priority: ${item.priority})`;
        orderList.appendChild(li);
      });
    }

async function handleAddWishlistItem(e) {
  e.preventDefault(); // 🧠 stops the form reload
  const name = document.getElementById('wishName').value.trim();
  const amount = parseFloat(document.getElementById('wishAmount').value);
  const priority = parseInt(document.getElementById('wishPriority').value, 10);
  if (name && !isNaN(amount)) {
    await addWishlistItem(name, amount, priority);
    e.target.reset();
    await loadData();   // refresh from DB
    renderAll();
  }
}

    
    async function deleteWishlistItem(index) {
        const confirmed = await customConfirm('Delete Wishlist Item', 'Are you sure you want to delete this item?');
        if (confirmed) {
            wishlist.splice(index, 1);
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            renderAll();
        }
    }

    // --- TRANSACTIONS & CSV ---
    function handleCSV(event) {
      showLoader();
      const bankType = document.getElementById('bankType').value;
      const files = event.target.files;
      let loadedTransactions = [];
      let filesRead = 0;
      
      if (files.length === 0) {
          hideLoader();
          return;
      }

      for (let file of files) {
        const reader = new FileReader();
        reader.onload = e => {
            const parsed = parseCSV(e.target.result, bankType);
            loadedTransactions = loadedTransactions.concat(parsed);
            filesRead++;
            if (filesRead === files.length) {
                transactions = transactions.concat(loadedTransactions);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderAll();
                hideLoader();
            }
        };
        reader.readAsText(file);
      }
    }
    
    function smartCategorize(desc) {
        const nameSurnameRegex = /\b[A-Za-zÀ-ÖØ-öø-ÿ'-]{2,} [A-Za-zÀ-ÖØ-öø-ÿ'-]{2,}\b/;
        const d = (desc || "");
        const d_lower = d.toLowerCase();

        for (const [cat, re] of Object.entries(smartCategoryRules)) {
            if (re.test(d_lower)) {
                return cat;
            }
        }

        if (nameSurnameRegex.test(d)) {
            const businessIndicators = /\b(ltd|limited|plc|inc|group|bank|restaurant|cafe|pub|shop|store|laundrette|news|motors|sons|web|online|ticket|fee|bill|services|co)\b/i;
            if (!businessIndicators.test(d_lower)) {
                return "Friends & Family";
            }
        }
        
        if (/food|meal|snack|drink|coffee/.test(d_lower)) return "Eating Out";
        if (/shop|store|purchase|retail/.test(d_lower)) return "Shopping";
        if (/bus|train|travel|flight/.test(d_lower)) return "Transport";
        if (/bill|utility|service/.test(d_lower)) return "Bills";
        if (/subscription|renewal/.test(d_lower)) return "Subscriptions";
        
        return "Uncategorized";
    }

    function parseCSV(text, bankType) {
        function tokenize(line, delim) {
            const out = []; let cur = ""; let inQ = false;
            for (let i=0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    if (inQ && line[i+1] === '"') { cur += '"'; i++; }
                    else inQ = !inQ;
                } else if (ch === delim && !inQ) { out.push(cur.trim()); cur = ""; }
                else { cur += ch; }
            }
            out.push(cur.trim()); return out;
        }

        const firstLine = text.split(/\r?\n/)[0] || "";
        const delim = (firstLine.match(/,/g) || []).length >= (firstLine.match(/;/g) || []).length ? ',' : ';';

        const rows = text.split(/\r?\n/).filter(r => r.trim() !== '');
        if (rows.length < 2) return [];
        
        const headers = tokenize(rows[0], delim).map(h => h.toLowerCase().trim());
        
        const dateIndex = headers.findIndex(h => /date/.test(h));
        const descIndex = headers.findIndex(h => /description|memo|details|narrative/.test(h));
        const amountIndex = headers.findIndex(h => /amount|value/.test(h));
        const creditIndex = headers.findIndex(h => /credit|paid in/.test(h));
        const debitIndex = headers.findIndex(h => /debit|paid out/.test(h));

        const parsedTransactions = [];

        for (let i = 1; i < rows.length; i++) {
            const values = tokenize(rows[i], delim);
            if (values.length < headers.length) continue;

            let amount = 0;
            if (amountIndex > -1) {
                amount = parseFloat(values[amountIndex]) || 0;
            } else if (creditIndex > -1 && debitIndex > -1) {
                const credit = parseFloat(values[creditIndex]) || 0;
                const debit = parseFloat(values[debitIndex]) || 0;
                amount = credit - debit;
            }
            
            if (bankType === 'aqua' && amount > 0) {
               const descriptionForCheck = (values[descIndex] || "").toLowerCase();
               if(!descriptionForCheck.includes('payment received')){
                   amount = -amount;
               }
            }
            
            let description = values[descIndex] || '';
            const referenceSeparator = /\s{3,}/;
            if (description.match(referenceSeparator)) {
                description = description.split(referenceSeparator)[0].trim();
            }

            const date = values[dateIndex] || new Date().toLocaleDateString('en-GB');

            const transaction = {
                Date: date,
                Description: description,
                Amount: amount,
                Category: 'Uncategorized'
            };
            
            let categorized = false;
            // First check user-defined rules
            for (let cat in categoryRules) {
                if (categoryRules[cat].some(r => r.test(description))) {
                    transaction.Category = cat;
                    categorized = true;
                    break;
                }
            }
            
            // If not matched by user rules, use the smart categorizer
            if (!categorized) {
                transaction.Category = smartCategorize(description);
            }

            parsedTransactions.push(transaction);
        }
        return parsedTransactions;
    }

    function renderSpendingTab() {
        const promptContainer = document.getElementById('initial-spending-prompt');
        const contentWrapper = document.getElementById('spending-content-wrapper');

        if (transactions.length === 0) {
            contentWrapper.style.display = 'none';
            promptContainer.style.display = 'block';
            promptContainer.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z" /></svg>
                    <h4>No Transactions Yet</h4>
                    <p>Upload a CSV file to get started.</p>
                </div>`;
        } else {
            promptContainer.style.display = 'none';
            contentWrapper.style.display = 'block';
            renderCharts();
        }
    }
    
    function renderTransactionsTab() {
        if (transactions.length > 0) {
            renderCategoryView();
            renderTransactionsByPrice();
        } else {
            document.getElementById('categoryView').innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z" /></svg><h4>No Transactions</h4><p>Upload a CSV in the Spending Analysis tab first.</p></div>';
            document.getElementById('price-table-container').innerHTML = '';
        }
    }

    function renderCategoryView() {
        const container = document.getElementById('categoryView');
        container.innerHTML = '<h3>Transactions by Category</h3>';

        const grouped = {};
        transactions.forEach((t, i) => {
            if (t.Amount < 0) { 
                if (!grouped[t.Category]) grouped[t.Category] = [];
                grouped[t.Category].push({ ...t, originalIndex: i });
            }
        });

        const sortedCategories = Object.keys(grouped).sort();

        if (sortedCategories.length === 0 && transactions.length > 0) {
            container.innerHTML += '<p>No spending transactions found to display.</p>'; 
            return;
        }

        sortedCategories.forEach(cat => {
            const div = document.createElement('div');
            div.style.marginTop = '10px';
            
            const header = document.createElement('h4');
            header.className = 'category-header';
            header.textContent = `${cat} (${grouped[cat].length})`;
            
            const list = document.createElement('ul');
            list.className = 'category-transactions';
            list.style.listStyleType = 'none';
            list.style.paddingLeft = '0';

            header.addEventListener('click', () => {
                header.classList.toggle('open');
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
            });
            
            // Sort transactions within the category by amount (highest to lowest)
            grouped[cat].sort((a, b) => Math.abs(b.Amount) - Math.abs(a.Amount));

            grouped[cat].forEach(item => {
                const li = document.createElement('li');
                li.className = 'item-card';
                li.innerHTML = `
                    <input type="checkbox" class="transaction-checkbox" data-index="${item.originalIndex}">
                    <span style="flex-grow: 1; margin-left: 10px;" ondblclick="editTransactionDescription(${item.originalIndex})">${item.Description || 'No Desc'} - £${Math.abs(item.Amount).toFixed(2)}</span>
                    <div>
                         <button class="delete-btn" onclick="deleteTransaction(${item.originalIndex})">Delete</button>
                    </div>
                `;
                list.appendChild(li);
            });
            div.appendChild(header);
            div.appendChild(list);
            container.appendChild(div);
        });

        document.querySelectorAll('.transaction-checkbox').forEach(cb => {
            cb.addEventListener('change', updateBulkEditUI);
        });
        updateBulkEditUI();
    }

    function renderTransactionsByPrice() {
        const container = document.getElementById('price-table-container');
        const spendingTransactions = transactions.map((t, i) => ({...t, originalIndex: i})).filter(t => t.Amount < 0)
            .sort((a, b) => Math.abs(b.Amount) - Math.abs(a.Amount));

        let tableHTML = `
            <h3>Transactions by Price</h3>
            <table id="price-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
        `;

        if (spendingTransactions.length === 0) {
            tableHTML += '<tr><td colspan="4" style="text-align: center; padding: 20px;">No spending transactions to show.</td></tr>';
        } else {
            spendingTransactions.forEach(t => {
                tableHTML += `
                    <tr>
                        <td>${t.Date}</td>
                        <td ondblclick="editTransactionDescription(${t.originalIndex})">${t.Description}</td>
                        <td>${t.Category}</td>
                        <td>£${Math.abs(t.Amount).toFixed(2)}</td>
                    </tr>
                `;
            });
        }
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }
    
    function updateBulkEditUI() {
        const container = document.getElementById('bulk-edit-container');
        const countEl = document.getElementById('selected-count');
        const checked = document.querySelectorAll('.transaction-checkbox:checked');
        
        if (checked.length > 0) {
            countEl.textContent = `${checked.length} item${checked.length > 1 ? 's' : ''} selected`;
            container.style.display = 'flex';
        } else {
            container.style.display = 'none';
        }
    }

    async function handleBulkEdit() {
        const checked = document.querySelectorAll('.transaction-checkbox:checked');
        if (checked.length === 0) {
            return customAlert('No Selection', 'Please select one or more transactions to edit.');
        }
        const indices = Array.from(checked).map(cb => parseInt(cb.dataset.index, 10));
        
        const newCategory = await showCategoryEditModal();

        if (newCategory) {
            indices.forEach(index => {
                transactions[index].Category = newCategory;
            });
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderAll();
        }
    }

    async function showCategoryEditModal(currentCategory = '') {
        const uniqueCategories = Array.from(new Set(Object.keys(smartCategoryRules).concat(transactions.map(t => t.Category).filter(Boolean))));
        
        const modalOverlay = document.getElementById('modal-overlay');
        const titleEl = document.getElementById('modal-title');
        const messageEl = document.getElementById('modal-message');
        const selectEl = document.getElementById('modal-category-select');
        const inputEl = document.getElementById('modal-input');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        titleEl.textContent = 'Change Category';
        messageEl.textContent = 'Select an existing category or enter a new one for the selected item(s).';
        
        selectEl.innerHTML = '<option value="">-- Select Existing --</option>';
        uniqueCategories.sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            if (cat === currentCategory) {
                option.selected = true;
            }
            selectEl.appendChild(option);
        });

        inputEl.placeholder = 'Or type a new category here';
        inputEl.value = '';

        selectEl.style.display = 'block';
        inputEl.style.display = 'block';
        cancelBtn.style.display = 'inline-block';
        
        modalOverlay.style.display = 'flex';

        return new Promise(resolve => {
            const confirmListener = () => {
                const newCat = inputEl.value.trim();
                const selectedCat = selectEl.value;
                cleanup();
                resolve(newCat || selectedCat || null);
            };
            const cancelListener = () => {
                cleanup();
                resolve(null);
            };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmListener);
                cancelBtn.removeEventListener('click', cancelListener);
                modalOverlay.style.display = 'none';
                selectEl.style.display = 'none';
                inputEl.style.display = 'none';
            };
            
            confirmBtn.addEventListener('click', confirmListener, { once: true });
            cancelBtn.addEventListener('click', cancelListener, { once: true });
        });
    }
    
    async function editTransactionDescription(index) {
        const transaction = transactions[index];
        if(!transaction) return;
        const newDescription = await showDescriptionEditModal(transaction.Description);
        if (newDescription !== null) {
            transactions[index].Description = newDescription;
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderAll();
        }
    }
    
    function showDescriptionEditModal(currentDescription) {
         return new Promise((resolve) => {
            const modalOverlay = document.getElementById('modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const selectEl = document.getElementById('modal-category-select');
            const inputEl = document.getElementById('modal-input');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            
            titleEl.textContent = 'Edit Transaction Name';
            messageEl.textContent = 'Enter the new name for this transaction.';
            inputEl.value = currentDescription;

            selectEl.style.display = 'none';
            inputEl.style.display = 'block';
            cancelBtn.style.display = 'inline-block';
            modalOverlay.style.display = 'flex';

            const confirmListener = () => {
                const newDesc = inputEl.value.trim();
                cleanup();
                resolve(newDesc || null);
            };
            const cancelListener = () => {
                cleanup();
                resolve(null);
            };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmListener);
                cancelBtn.removeEventListener('click', cancelListener);
                modalOverlay.style.display = 'none';
                inputEl.style.display = 'none';
            };
            
            confirmBtn.addEventListener('click', confirmListener, { once: true });
            cancelBtn.addEventListener('click', cancelListener, { once: true });
         });
    }


    async function deleteTransaction(i) {
      const confirmed = await customConfirm('Delete Transaction', 'Are you sure you want to delete this transaction?');
      if (confirmed) {
        transactions.splice(i,1);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        renderAll();
      }
    }

    // --- CHARTS ---
    function renderCharts() {
        renderPieChart();
        renderBarChart();
    }
    
    function getChartData() {
        const categories = {};
        transactions.forEach(row => {
            let amount = parseFloat(row['Amount'] || 0);
            if (amount < 0) {
                let cat = row['Category'] || 'Uncategorized';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += Math.abs(amount);
            }
        });
        return categories;
    }

    function renderPieChart() {
        const categories = getChartData();
        const chartLabels = Object.keys(categories);
        const chartData = Object.values(categories);
        const textColor = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        const pieColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#FDB45C', '#949FB1', '#4D5360'];

       const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: window.innerWidth < 600 ? 'bottom' : 'right',
                    labels: { color: textColor } 
                }
            }
        };


        if (spendingPieChart) {
            spendingPieChart.data.labels = chartLabels;
            spendingPieChart.data.datasets[0].data = chartData;
            spendingPieChart.data.datasets[0].backgroundColor = pieColors;
            spendingPieChart.options = chartOptions;
            spendingPieChart.update();
        } else {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            spendingPieChart = new Chart(ctx, { 
                type: 'pie', 
                data: { 
                    labels: chartLabels, 
                    datasets: [{ 
                        data: chartData,
                        backgroundColor: pieColors
                    }] 
                },
                options: chartOptions
            });
        }
    }

    function renderBarChart() {
        const categories = getChartData();
        const chartLabels = Object.keys(categories);
        const chartData = Object.values(categories);
        const textColor = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        const barColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#FDB45C', '#949FB1', '#4D5360'];

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    ticks: { color: textColor },
                    grid: { color: 'rgba(128, 128, 128, 0.2)' }
                },
                y: {
                    ticks: { color: textColor },
                    grid: { color: 'rgba(128, 128, 128, 0.1)' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        };

        if (spendingBarChart) {
            spendingBarChart.data.labels = chartLabels;
            spendingBarChart.data.datasets[0].data = chartData;
            spendingBarChart.data.datasets[0].backgroundColor = barColors;
            spendingBarChart.options = chartOptions;
            spendingBarChart.update();
        } else {
            const ctx = document.getElementById('spendingBarChart').getContext('2d');
            spendingBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Spending',
                        data: chartData,
                        backgroundColor: barColors
                    }]
                },
                options: chartOptions
            });
        }
    }


    // --- BUDGETS ---
async function handleAddBudget(e) {
  e.preventDefault();
  const category = document.getElementById('budgetCategory').value.trim();
  const limit_amount = parseFloat(document.getElementById('budgetAmount').value);

  if (category && !isNaN(limit_amount)) {
    await addBudget(category, limit); // ✅ calls backend POST /api/budgets
    e.target.reset();
    await loadData(); // refresh from DB
    renderAll();      // re-render UI
  }
}

    
    async function removeBudget(id) {
  const confirmed = confirm("Are you sure you want to delete this budget?");
  if (confirmed) {
    await deleteBudget(id); // calls your backend helper
    await loadData();       // reloads fresh data from DB
    renderAll();            // re-renders UI
  }
}


    function renderBudgets() {
        const container = document.getElementById('budgetsList');
        container.innerHTML = '<h3>Your Budgets</h3>';
        if (budgets.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M15.5,16C16.33,16 17,15.33 17,14.5C17,13.67 16.33,13 15.5,13C14.67,13 14,13.67 14,14.5C14,15.33 14.67,16 15.5,16M15,11H16V12H15V11M9,11H13V12H9V11M9,9H16V10H9V9M9,7H16V8H9V7Z" /></svg>
                <h4>No Budgets Set</h4>
                <p>Create a budget for a category to track your spending against a limit.</p>
            </div>`;
            return;
        }
        const spendingByCategory = {};
        transactions.forEach(t => {
            if (t.Amount < 0) {
                const cat = t.Category;
                if (!spendingByCategory[cat]) spendingByCategory[cat] = 0;
                spendingByCategory[cat] += Math.abs(t.Amount);
            }
        });

        budgets.forEach((budget, index) => {
            const spent = spendingByCategory[budget.category] || 0;
            const remaining = budget.limit_amount - spent;
            const percentage = (budget.limit_amount > 0) ? (spent / budget.limit_amount) * 100 : 0;
            const isOverspent = percentage > 100;
            const isSeverelyOverspent = percentage >= 200;

            let remainingText = '';
            let barWidth = 0;
            let barClass = 'progress-bar';
            let titleColor = '';

            if (isSeverelyOverspent) {
                remainingText = `<span style="color: var(--overspent-color); font-weight: bold;">Completely exceeded budget</span>`;
                barWidth = 100;
                barClass += ' over cracked';
                titleColor = `color: var(--overspent-color);`;
            } else if (isOverspent) {
                remainingText = `<span style="color: var(--overspent-color); font-weight: bold;">£${Math.abs(remaining).toFixed(2)} overspent</span>`;
                barWidth = percentage > 100 ? 100 : percentage; 
                barClass += ' over';
                titleColor = `color: var(--overspent-color);`;
            } else {
                remainingText = `£${remaining.toFixed(2)} remaining`;
                barWidth = percentage;
            }


   // ✅ Add a delete button to each budget
    container.innerHTML += `
        <div class="budget-item">
            <h4 style="${titleColor}">${budget.category}</h4>
            <div class="progress-bar-bg">
                <div class="${barClass}" style="width: ${barWidth}%;"></div>
            </div>
            <p>Limit: £${budget.limit_amount.toFixed(2)} | Spent: £${spent.toFixed(2)} | ${remainingText}</p>
            <button class="delete-btn" onclick="removeBudget(${budget.id})">🗑️ Delete</button>
        </div>
    `;
})};


    // --- INSIGHTS ---
    function renderInsightsTab() {
        const container = document.getElementById('insights-container');
        if (transactions.length === 0) {
            container.innerHTML = `<div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z" /></svg>
                <h4>No Data for Insights</h4>
                <p>Upload a CSV file in the 'Spending Analysis' tab to generate insights.</p>
            </div>`;
            return;
        }

        const spendingTransactions = transactions.filter(t => t.Amount < 0);
        if (spendingTransactions.length === 0) {
             container.innerHTML = `<div class="empty-state">
                <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z" /></svg>
                <h4>No Spending Data</h4>
                <p>No spending transactions found to generate insights.</p>
            </div>`;
            return;
        }

        // 1. Biggest Purchase
        const biggestPurchase = [...spendingTransactions].sort((a,b) => Math.abs(b.Amount) - Math.abs(a.Amount))[0];

        // 2 & 3. Category spending
        const categories = getChartData();
        const sortedCategories = Object.entries(categories).sort(([,a],[,b]) => b-a);
        
        const biggestCategory = sortedCategories.length > 0 ? sortedCategories[0] : null;
        const secondBiggestCategory = sortedCategories.length > 1 ? sortedCategories[1] : null;

        container.innerHTML = `
            <div class="summary-card">
                <h3>Biggest Purchase</h3>
                <p>Your single biggest purchase was <strong>£${Math.abs(biggestPurchase.Amount).toFixed(2)}</strong> on <strong>${biggestPurchase.Description}</strong>.</p>
            </div>
            <div class="summary-card">
                <h3>Top Spending Category</h3>
                <p>${biggestCategory ? `You spent the most money on <strong>${biggestCategory[0]}</strong>, totalling <strong>£${biggestCategory[1].toFixed(2)}</strong>.` : 'Not enough data.'}</p>
            </div>
            <div class="summary-card">
                <h3>Area for Improvement</h3>
                <p>${secondBiggestCategory ? `You could also look to cut down on <strong>${secondBiggestCategory[0]}</strong>, where you spent <strong>£${secondBiggestCategory[1].toFixed(2)}</strong>.` : 'Not enough data to suggest an area for improvement.'}</p>
            </div>
        `;
    }
    
    // --- CATEGORIES (REMOVED UI) ---
    function populateCategoryDropdowns() {
        const budgetSelect = document.getElementById('budgetCategory');
        budgetSelect.innerHTML = '';
        
        const allCategoryNames = new Set([
            ...Object.keys(categoryRules),
            ...Object.keys(smartCategoryRules)
        ]);
        transactions.forEach(t => allCategoryNames.add(t.Category));
        if(!allCategoryNames.has("Friends & Family")) allCategoryNames.add("Friends & Family");


        Array.from(allCategoryNames).sort().forEach(cat => {
            if(!cat) return;
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            budgetSelect.appendChild(option);
        });
    }

  </script>
</body>
</html>

